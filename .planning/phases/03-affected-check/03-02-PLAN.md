---
phase: 03-affected-check
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/[locale]/check/page.tsx
  - src/app/[locale]/check/steps/sector-selection.tsx
  - src/app/[locale]/check/steps/company-size.tsx
  - src/app/[locale]/check/steps/result.tsx
  - src/app/[locale]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can select their sector from all 18 NIS2 sectors grouped by Anlage 1 and Anlage 2"
    - "User can select a subsector when the chosen sector has subsectors (progressive disclosure)"
    - "Selecting 'Mein Sektor ist nicht aufgeführt' skips to 'nicht betroffen' result immediately"
    - "User can enter employee count and annual revenue with thousand-separator formatting"
    - "User can optionally enter balance sheet total with info tooltip"
    - "User can check KRITIS checkbox with tooltip explanation"
    - "System classifies as besonders-wichtig, wichtig, or nicht-betroffen using classifyEntity()"
    - "Result shows color-coded card with icon, classification label, legal reference, and expandable explanation"
    - "Nicht-betroffen result shows supply chain hint info box"
    - "Primary CTA 'Reifegrad prüfen' and Secondary CTA 'Erneut prüfen' are shown on result"
    - "Step indicator shows progress through 3 steps"
    - "User can navigate back without losing entered data"
  artifacts:
    - path: "src/app/[locale]/check/page.tsx"
      provides: "Main wizard container page at /[locale]/check route"
      exports: ["default"]
    - path: "src/app/[locale]/check/steps/sector-selection.tsx"
      provides: "Step 1: Sector and subsector selection with grouped dropdown"
      exports: ["SectorSelectionStep"]
    - path: "src/app/[locale]/check/steps/company-size.tsx"
      provides: "Step 2: Employee count, revenue, balance sheet, KRITIS inputs"
      exports: ["CompanySizeStep"]
    - path: "src/app/[locale]/check/steps/result.tsx"
      provides: "Step 3: Classification result with color card, explanation, CTAs"
      exports: ["ResultStep"]
  key_links:
    - from: "src/app/[locale]/check/page.tsx"
      to: "src/stores/wizard-store.ts"
      via: "useWizardStore hook for step routing"
      pattern: "useWizardStore"
    - from: "src/app/[locale]/check/steps/sector-selection.tsx"
      to: "src/lib/nis2/sectors.ts"
      via: "SECTORS import for dropdown population"
      pattern: "SECTORS|getSectorsByAnlage"
    - from: "src/app/[locale]/check/steps/result.tsx"
      to: "src/lib/nis2/classification.ts"
      via: "classifyEntity() call with form data"
      pattern: "classifyEntity"
    - from: "src/app/[locale]/check/steps/result.tsx"
      to: "src/messages/de.json"
      via: "useTranslations for classification reasons and labels"
      pattern: "useTranslations"
    - from: "src/app/[locale]/page.tsx"
      to: "src/app/[locale]/check/page.tsx"
      via: "Landing page CTA links to /check"
      pattern: "href.*check"
---

<objective>
Build the complete 3-step Affected Check wizard UI: sector selection (Step 1), company size inputs (Step 2), and classification result display (Step 3), plus the wizard container page and landing page CTA link.

Purpose: Deliver the first interactive user feature -- users can determine NIS2 affected status through a guided wizard that classifies their company using the existing §28 BSIG classification logic from Phase 2.
Output: Working wizard at /[locale]/check with all 3 steps, form validation, classification, and result display.
</objective>

<execution_context>
@C:\Users\mjoan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mjoan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-affected-check/03-RESEARCH.md
@.planning/phases/03-affected-check/03-CONTEXT.md
@.planning/phases/03-affected-check/03-01-SUMMARY.md
@src/stores/wizard-store.ts
@src/lib/nis2/types.ts
@src/lib/nis2/sectors.ts
@src/lib/nis2/classification.ts
@src/messages/de.json
@src/messages/en.json
@src/app/[locale]/page.tsx
@src/app/[locale]/layout.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wizard container page and all 3 step components</name>
  <files>
    src/app/[locale]/check/page.tsx
    src/app/[locale]/check/steps/sector-selection.tsx
    src/app/[locale]/check/steps/company-size.tsx
    src/app/[locale]/check/steps/result.tsx
    src/app/[locale]/page.tsx
  </files>
  <action>
**IMPORTANT HYDRATION PATTERN:** The wizard uses zustand persist (localStorage). To avoid Next.js hydration mismatch, the check/page.tsx MUST use `'use client'` and the isClient pattern:
```typescript
const [isClient, setIsClient] = useState(false);
useEffect(() => setIsClient(true), []);
if (!isClient) return <WizardSkeleton />;
```
The skeleton should render the same outer structure (max-w-3xl container, StepIndicator placeholder) to minimize layout shift.

**A) src/app/[locale]/check/page.tsx** — Main wizard container.

`'use client'` component that:
1. Reads `currentStep` from `useWizardStore()`
2. Uses the isClient hydration guard pattern (see above)
3. Renders `StepIndicator` at top with step labels from `useTranslations('check.steps')`
4. Conditionally renders the correct step component based on `currentStep`:
   - 0: `<SectorSelectionStep />`
   - 1: `<CompanySizeStep />`
   - 2: `<ResultStep />`
5. Layout: `max-w-3xl mx-auto px-4 py-8 sm:py-12` centered container
6. Page title: `<h1>` with `check.title` translation
7. Subtitle: `<p>` with `check.subtitle` translation (shown only on steps 0 and 1, not on result)

**B) src/app/[locale]/check/steps/sector-selection.tsx** — Step 1.

`'use client'` component using React Hook Form + Zod:

Zod schema:
```typescript
const sectorSchema = z.object({
  sectorId: z.string().min(1, t('check.sectorStep.sectorRequired')),
  subsectorId: z.string().nullable(),
});
```

NOTE: Since the Zod schema needs translation strings and `t()` is a hook, define the schema INSIDE the component function (not at module level). This is fine for a small schema.

Form setup:
- `useForm` with `zodResolver(sectorSchema)`, `mode: 'onSubmit'`
- `defaultValues` from `formData` in wizard store
- On submit: `updateFormData(data)` then `nextStep()`

UI elements:
1. Grouped Select dropdown for sectors (shadcn Select):
   - `<SelectGroup>` with `<SelectLabel>` "Sektoren hoher Kritikalität (Anlage 1)" containing all Anlage 1 sectors
   - `<SelectGroup>` with `<SelectLabel>` "Sonstige kritische Sektoren (Anlage 2)" containing all Anlage 2 sectors
   - `<Separator />` after groups
   - `<SelectItem value="not-listed">` "Mein Sektor ist nicht aufgeführt"
   - Use `<SelectContent position="popper" className="max-h-[60vh]">` for mobile compatibility
   - Sector names via `useTranslations('sectors')` with `t(sector.nameKey.replace('sectors.', ''))` pattern — BUT check actual nameKey format: `'sectors.energy.name'` means call `t('energy.name')` when scoped to `'sectors'`

2. Conditional subsector dropdown (progressive disclosure):
   - Only shows when selected sector has subsectors (check `selectedSector.subsectors.length > 0`)
   - Use `watch('sectorId')` from React Hook Form to track selection
   - When sector changes, reset subsectorId to null via `setValue('subsectorId', null)`
   - Subsector names via translations using same pattern

3. "Not listed" shortcut:
   - When `sectorId === 'not-listed'`, call `updateFormData({ sectorId: 'not-listed' })` and set `currentStep` directly to 2 (result step), skipping company size
   - The result step must handle this case and show "nicht betroffen" with supply chain hint

4. shadcn Select integration with React Hook Form:
   - shadcn Select uses `onValueChange` not native `onChange`. Use `Controller` from react-hook-form:
   ```typescript
   <Controller
     name="sectorId"
     control={control}
     render={({ field }) => (
       <Select value={field.value} onValueChange={field.onChange}>
         ...
       </Select>
     )}
   />
   ```

5. Navigation: Render `<WizardNavigation>` with `isFirstStep={true}` and `isLastStep={false}`

6. Error display: Show validation error below Select when present, using `text-sm text-red-600`

**C) src/app/[locale]/check/steps/company-size.tsx** — Step 2.

`'use client'` component using React Hook Form + Zod + react-number-format:

Zod schema (defined inside component for t() access):
```typescript
const companySizeSchema = z.object({
  employees: z.number({ required_error: t('check.sizeStep.employeesRequired') }).min(1, t('check.sizeStep.employeesRequired')),
  annualRevenue: z.number({ required_error: t('check.sizeStep.revenueRequired') }).min(0, t('check.sizeStep.revenueRequired')),
  balanceSheet: z.number().optional().default(0),
  isKritis: z.boolean().default(false),
});
```

Form setup:
- `useForm` with `zodResolver(companySizeSchema)`, `mode: 'onSubmit'`
- `defaultValues` from `formData` in wizard store (use 0 defaults for numbers if not set)
- On submit: `updateFormData(data)` then `nextStep()`

UI elements:
1. Employee count input: `NumericFormat` with `Controller`:
   - `customInput={Input}`, `type="text"`, `inputMode="numeric"`
   - `thousandSeparator="."`, `decimalSeparator=","`
   - `allowNegative={false}`, `decimalScale={0}`
   - `onValueChange={(values) => field.onChange(values.floatValue ?? 0)}`
   - Label: `check.sizeStep.employeesLabel`

2. Annual revenue input: Same `NumericFormat` pattern:
   - Add `suffix=" €"` or no suffix (label says EUR already)
   - `thousandSeparator="."`, `decimalSeparator=","`
   - `decimalScale={0}`, `allowNegative={false}`
   - Label: `check.sizeStep.revenueLabel`

3. Balance sheet input (optional):
   - Same `NumericFormat` pattern
   - Label with "(optional)" suffix: `check.sizeStep.balanceSheetLabel` + `check.sizeStep.balanceSheetOptional`
   - Info icon with `Tooltip` (shadcn): `check.sizeStep.balanceSheetTooltip`
   - Use `Info` icon from lucide-react next to label, wrapped in `TooltipTrigger`
   - Tooltip requires `TooltipProvider` wrapping (can wrap just this field group)

4. KRITIS checkbox:
   - `Checkbox` (shadcn) with label `check.sizeStep.kritisLabel`
   - Styled subtly: smaller text, muted color, positioned below the number inputs
   - Info icon with `Tooltip`: `check.sizeStep.kritisTooltip`
   - Use `Controller` to connect shadcn Checkbox with React Hook Form:
   ```typescript
   <Controller
     name="isKritis"
     control={control}
     render={({ field }) => (
       <Checkbox checked={field.value} onCheckedChange={field.onChange} />
     )}
   />
   ```

5. Navigation: `<WizardNavigation>` with `isFirstStep={false}`, `isLastStep={true}`
   - Back calls `prevStep()` from store
   - Submit triggers form handleSubmit

6. Error display: Below each field when validation fails

7. Accessibility: All inputs have `id` matching `htmlFor` on Label, `aria-invalid` when errored, `aria-describedby` pointing to error message `<p>` ids.

**D) src/app/[locale]/check/steps/result.tsx** — Step 3.

`'use client'` component that:

1. Reads `formData` from wizard store
2. Calls `classifyEntity()` with the stored form data:
   - Must handle the "not-listed" sectorId case: if `sectorId === 'not-listed'`, directly show `nicht-betroffen` result without calling classifyEntity
   - For normal cases: construct `ClassificationInput` from formData (use `balanceSheet: formData.balanceSheet ?? 0` for optional field)
3. Displays result in a color-coded Card:

   Result card configs:
   - `besonders-wichtig`: `bg-red-50 border-red-500 border-2`, `AlertCircle` icon in `text-red-600`, title text `text-red-900`
   - `wichtig`: `bg-orange-50 border-orange-500 border-2`, `AlertTriangle` icon in `text-orange-600`, title text `text-orange-900`
   - `nicht-betroffen`: `bg-green-50 border-green-500 border-2`, `CheckCircle` icon in `text-green-600`, title text `text-green-900`

   Card structure:
   - Icon (h-10 w-10) + classification label (CardTitle, text-2xl) in flex row
   - Legal reference as CardDescription (e.g., "§28 Abs. 1 Nr. 1 BSIG")

4. Expandable "Warum?" section:
   - Button/trigger styled as text link: "Warum diese Einstufung?" (check.resultStep.whyTitle)
   - Use a simple `useState` toggle (no external accordion library needed)
   - When expanded: shows the `reason` text from ClassificationResult (which is a translation key -- resolve via `useTranslations('classification')`)
   - Show legal reference with label: "Rechtsgrundlage: §28 Abs. X BSIG"

5. Supply chain hint (only for `nicht-betroffen`):
   - Yellow-bordered info box below result card: `bg-yellow-50 border-yellow-400 border p-4 rounded-lg`
   - `Info` icon from lucide-react in `text-yellow-600`
   - Title: `check.resultStep.supplyChainTitle`
   - Text: `check.resultStep.supplyChainText` (or use existing `classification.supplychainHint` from de.json)

6. CTAs:
   - Primary: `Button size="lg"` "Reifegrad prüfen" (check.resultStep.ctaPrimary)
     - For now, link to `#` or `/gap-analysis` (Phase 4 route, not yet built). Use `Link` from `next/link` with locale-aware path. If the route doesn't exist yet, still link to `/[locale]/gap-analysis` -- it will 404 but will be wired in Phase 4.
     - Actually, use `useRouter` from `next/navigation` for navigation to keep it clean.
   - Secondary: `Button variant="outline" size="lg"` "Erneut prüfen" (check.resultStep.ctaSecondary)
     - Calls `reset()` from wizard store (resets formData and currentStep to 0)

7. No navigation component on result step (CTAs replace it)

**E) Update landing page CTA** — Modify `src/app/[locale]/page.tsx`:
- Change the hero CTA `<Button>` to wrap in or replace with a `Link` from `next/link` pointing to `/check` (or `/{locale}/check`)
- Use `useTranslations` already present. The link should be locale-aware.
- Since the page is a server component, use `<Link href="/check">` which next-intl middleware will handle.
- Wrap the `<Button>` with `asChild` prop and nest `<Link>` inside:
  ```tsx
  <Button size="lg" className="text-lg px-8 py-6" asChild>
    <Link href="/check">{t('cta')}</Link>
  </Button>
  ```
- Import `Link` from `next/link` at the top of the file.
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- no TypeScript errors
2. Run `npm run build` -- build succeeds with check route
3. Run `npm run dev` and navigate to `http://localhost:3000/de/check`:
   - Step indicator shows "1. Sektor" as active
   - Sector dropdown shows 14 sectors grouped by Anlage
   - Selecting "Energie" shows subsector dropdown with 4 options
   - Selecting "Post- und Kurierdienste" shows no subsector dropdown
   - Clicking "Weiter" without selection shows validation error
   - After selecting sector, clicking "Weiter" advances to step 2
4. On step 2:
   - Employee and revenue inputs format with thousand separators (type "1000" -> "1.000")
   - Balance sheet shows "(optional)" and info tooltip
   - KRITIS checkbox with tooltip is visible
   - "Zurück" returns to step 1 with sector selection preserved
   - "Ergebnis anzeigen" validates and shows result
5. On result step:
   - Color-coded card displays correct classification
   - "Warum?" expands to show legal reasoning
   - "Reifegrad prüfen" and "Erneut prüfen" buttons visible
   - "Erneut prüfen" resets to step 1
6. Test special cases:
   - "Mein Sektor ist nicht aufgeführt" -> straight to green "nicht betroffen" with supply chain hint
   - Selecting digital-infrastructure/dns -> "besonders wichtig" regardless of company size
   - 300 employees + Energie sector -> "besonders wichtig" (>=250, Anlage 1)
   - 60 employees + Postal sector -> "wichtig" (>=50, any sector)
   - 10 employees + 5M revenue + Postal sector -> "nicht betroffen" (below all thresholds)
7. Navigate to landing page, verify CTA links to /check
  </verify>
  <done>
- Complete 3-step wizard at /[locale]/check works end-to-end
- Sector selection with grouped dropdown (Anlage 1/2) and progressive subsector disclosure
- Company size inputs with thousand-separator formatting and optional balance sheet
- Color-coded result card with classification, legal reference, expandable explanation
- Supply chain hint for "nicht betroffen" results
- "Mein Sektor ist nicht aufgeführt" shortcut to nicht-betroffen
- Special cases (DNS, TLD, qTSP, KRITIS) correctly classified as besonders-wichtig
- Landing page CTA links to /check
- All text internationalized (DE/EN)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete NIS2 Affected Check wizard with 3-step flow: sector selection, company size inputs, and classification result with legal references</what-built>
  <how-to-verify>
1. Open http://localhost:3000/de/check
2. Verify step indicator shows 3 steps with "Sektor" highlighted
3. Select "Energie" -> verify subsector dropdown appears with "Stromversorgung", "Fernwärme", etc.
4. Select "Stromversorgung", click "Weiter"
5. Enter 300 employees, 60.000.000 EUR revenue
6. Click "Ergebnis anzeigen"
7. Verify: RED card showing "Besonders wichtige Einrichtung" with "§28 Abs. 1 Nr. 4 BSIG"
8. Click "Warum?" -> verify expandable text shows explanation
9. Click "Erneut prüfen" -> verify reset to step 1

Test "nicht betroffen" path:
10. Select "Post- und Kurierdienste" (no subsector should appear)
11. Enter 10 employees, 500.000 EUR revenue
12. Click "Ergebnis anzeigen"
13. Verify: GREEN card showing "Nicht betroffen" with supply chain hint box below

Test shortcut path:
14. Click "Erneut prüfen", select "Mein Sektor ist nicht aufgeführt"
15. Verify: Jumps directly to GREEN result with supply chain hint (no size step)

Test special case:
16. Click "Erneut prüfen", select "Digitale Infrastruktur" -> "DNS-Diensteanbieter"
17. Enter 5 employees, 100.000 EUR (tiny company)
18. Verify: RED card "Besonders wichtige Einrichtung" (DNS always qualifies)

19. Switch language to EN, verify all text switches to English
20. Verify landing page CTA button links to /check
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
**Phase 3 Requirements Check:**
- AFFECT-01: User kann Sektor aus allen 18 NIS2-Sektoren auswählen -> Grouped dropdown with all 14 sectors (7 Anlage 1 + 7 Anlage 2) plus subsectors
- AFFECT-02: User gibt Mitarbeiterzahl und Jahresumsatz ein -> NumericFormat inputs with thousand separators
- AFFECT-03: System klassifiziert korrekt -> classifyEntity() from Phase 2 wired to result display
- AFFECT-04: Sonderfälle korrekt behandelt -> DNS, TLD, qTSP via alwaysQualified, KRITIS via checkbox, Telko via sector matching
- AFFECT-05: Ergebnis zeigt Klassifizierung mit Begründung und Gesetzesreferenz -> Color card + expandable "Warum?" + legal reference
- AFFECT-06: Bei "nicht betroffen": Lieferketten-Hinweis -> Yellow info box with Art. 21(2)(d) reference

**Technical Verification:**
- `npm run build` succeeds
- `npx tsc --noEmit` passes
- No hydration warnings in browser console
- Form data persists in localStorage across page refreshes
- All wizard text available in DE and EN
</verification>

<success_criteria>
- Working 3-step wizard at /[locale]/check accessible from landing page CTA
- All 18 sectors selectable with correct Anlage grouping
- Progressive subsector disclosure works
- "Mein Sektor ist nicht aufgeführt" shortcut to nicht-betroffen result
- Number inputs with German thousand-separator formatting (1.000, 10.000.000)
- classifyEntity() produces correct results for all requirement cases
- Color-coded result card (red/orange/green) with icon + text + legal reference
- Expandable "Warum?" section with classification reasoning
- Supply chain hint for nicht-betroffen results
- Both CTAs functional (Reifegrad prüfen links forward, Erneut prüfen resets)
- Full DE/EN internationalization
- No hydration errors, form data persists in localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/03-affected-check/03-02-SUMMARY.md`
</output>
