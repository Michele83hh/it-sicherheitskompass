---
phase: 03-affected-check
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/wizard-store.ts
  - src/messages/de.json
  - src/messages/en.json
  - src/app/[locale]/check/components/step-indicator.tsx
  - src/app/[locale]/check/components/navigation.tsx
  - src/components/ui/select.tsx
  - src/components/ui/input.tsx
  - src/components/ui/label.tsx
  - src/components/ui/tooltip.tsx
  - src/components/ui/checkbox.tsx
  - src/components/ui/separator.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Wizard store persists form data (sectorId, subsectorId, employees, annualRevenue, balanceSheet, isKritis) and currentStep to localStorage"
    - "Step indicator renders 3 numbered circles with connecting lines showing current, completed, and upcoming states"
    - "Navigation component renders Back/Next buttons with correct disabled states"
    - "All wizard UI text is available in both DE and EN translations"
  artifacts:
    - path: "src/stores/wizard-store.ts"
      provides: "Extended wizard store with formData, persist middleware, step navigation"
      contains: "persist"
    - path: "src/app/[locale]/check/components/step-indicator.tsx"
      provides: "3-step progress indicator component"
      exports: ["StepIndicator"]
    - path: "src/app/[locale]/check/components/navigation.tsx"
      provides: "Back/Next/Submit navigation buttons"
      exports: ["WizardNavigation"]
    - path: "src/messages/de.json"
      provides: "German translations for check wizard"
      contains: "check"
    - path: "src/messages/en.json"
      provides: "English translations for check wizard"
      contains: "check"
  key_links:
    - from: "src/stores/wizard-store.ts"
      to: "localStorage"
      via: "zustand persist middleware"
      pattern: "persist"
    - from: "src/stores/wizard-store.ts"
      to: "src/lib/nis2/types.ts"
      via: "ClassificationInput type import"
      pattern: "ClassificationInput"
---

<objective>
Install all Phase 3 dependencies, extend the wizard store with form data persistence, create shared wizard UI components (step indicator, navigation), and add all i18n translations for the affected check wizard.

Purpose: Establish the foundation that step components (Plan 02) will consume -- store, UI primitives, translations, and shared components.
Output: Extended wizard store, shadcn components installed, step indicator + navigation components, DE/EN translations for check wizard.
</objective>

<execution_context>
@C:\Users\mjoan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mjoan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-affected-check/03-RESEARCH.md
@.planning/phases/03-affected-check/03-CONTEXT.md
@src/stores/wizard-store.ts
@src/lib/nis2/types.ts
@src/lib/nis2/sectors.ts
@src/lib/nis2/classification.ts
@src/messages/de.json
@src/messages/en.json
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and shadcn components</name>
  <files>
    package.json
    src/components/ui/select.tsx
    src/components/ui/input.tsx
    src/components/ui/label.tsx
    src/components/ui/tooltip.tsx
    src/components/ui/checkbox.tsx
    src/components/ui/separator.tsx
  </files>
  <action>
Install npm packages and shadcn UI components needed for the wizard form.

1. Install form libraries:
```bash
npm install react-hook-form @hookform/resolvers zod react-number-format
```

2. Install shadcn components (run each separately to avoid interactive prompts):
```bash
npx shadcn@latest add select --yes
npx shadcn@latest add input --yes
npx shadcn@latest add label --yes
npx shadcn@latest add tooltip --yes
npx shadcn@latest add checkbox --yes
npx shadcn@latest add separator --yes
```

After installation, verify all 6 shadcn component files exist in `src/components/ui/` and that react-hook-form, zod, and react-number-format appear in package.json dependencies.
  </action>
  <verify>
Run `npm ls react-hook-form zod react-number-format` to confirm packages installed.
Run `ls src/components/ui/` to confirm select.tsx, input.tsx, label.tsx, tooltip.tsx, checkbox.tsx, separator.tsx all exist alongside existing button.tsx and card.tsx.
  </verify>
  <done>
8 shadcn components in src/components/ui/ (button, card + 6 new). react-hook-form, @hookform/resolvers, zod, react-number-format in package.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend wizard store, create shared components, add i18n translations</name>
  <files>
    src/stores/wizard-store.ts
    src/app/[locale]/check/components/step-indicator.tsx
    src/app/[locale]/check/components/navigation.tsx
    src/messages/de.json
    src/messages/en.json
  </files>
  <action>
**A) Extend wizard-store.ts** — Replace the current minimal store with an extended version using zustand persist middleware.

The store must:
- Import `persist` from `zustand/middleware`
- Import `ClassificationInput` from `@/lib/nis2/types`
- Track `currentStep: number` (0, 1, 2 for the 3 wizard steps)
- Track `totalSteps: 3` (constant)
- Track `formData: Partial<ClassificationInput>` (partial because fields are filled step-by-step)
- Provide actions: `setStep(step)`, `nextStep()`, `prevStep()`, `updateFormData(data)`, `reset()`
- `nextStep()` clamps to `totalSteps - 1`, `prevStep()` clamps to 0
- Use `persist` middleware with key `'nis2-wizard-storage'`
- Use `partialize` to only persist `formData` and `currentStep` (not actions)
- Add `'use client'` directive is NOT needed on the store file itself (stores are plain TS, not components)

Reference the pattern from 03-RESEARCH.md Pattern 1.

**B) Create step-indicator.tsx** — A `'use client'` component that renders the 3-step wizard progress.

Props: `currentStep: number`, `steps: { label: string }[]`

Render:
- Horizontal `<nav aria-label="Fortschritt">` with `<ol>` containing 3 items
- Each step: numbered circle (1, 2, 3) with step label below
- Connecting lines between circles
- States:
  - Completed (index < currentStep): `bg-blue-800 text-white border-blue-800` circle, `bg-blue-800` line (use brand-blue #1e40af via Tailwind `bg-[var(--brand-blue)]` or `bg-blue-800`)
  - Active (index === currentStep): `bg-blue-800 text-white border-blue-800` circle, ring/shadow effect
  - Upcoming (index > currentStep): `bg-white text-gray-400 border-gray-300` circle, `bg-gray-300` line
- Step labels use `text-sm` below circles, `font-medium` when active
- Responsive: labels hidden on mobile (`hidden sm:block`), circles always visible
- Use Tailwind classes only, no external dependencies

Export: `StepIndicator`

**C) Create navigation.tsx** — A `'use client'` component for wizard Back/Next buttons.

Props:
- `onBack?: () => void` — if undefined, Back button not rendered (step 0)
- `onNext?: () => void` — called on Next/Submit click (step components handle form submit, so this is optional)
- `isFirstStep: boolean` — hides Back button
- `isLastStep: boolean` — changes Next to Submit with different styling
- `submitLabel?: string` — custom label for final step submit (default: "Ergebnis anzeigen")
- `nextLabel?: string` — custom label for next (default: "Weiter")
- `backLabel?: string` — custom label for back (default: "Zurueck")

Render:
- `div` with `flex justify-between` layout
- Back button: `Button variant="outline"` with `ChevronLeft` icon from lucide-react
- Next/Submit button: `Button` (primary) with `ChevronRight` icon (or no icon on last step)
- Back button has `type="button"`, Next button has `type="submit"` (so it triggers form submission)

Export: `WizardNavigation`

**D) Add i18n translations for check wizard** — Add a `"check"` key to both `de.json` and `en.json`.

German (`de.json`) - add at top level alongside existing keys:
```json
"check": {
  "title": "NIS2-Betroffenheitspruefung",
  "subtitle": "Pruefen Sie in wenigen Schritten, ob Ihr Unternehmen von NIS2 betroffen ist",
  "steps": {
    "sector": "Sektor",
    "companySize": "Unternehmensgroesse",
    "result": "Ergebnis"
  },
  "sectorStep": {
    "title": "In welchem Sektor ist Ihr Unternehmen taetig?",
    "sectorLabel": "Sektor",
    "sectorPlaceholder": "Sektor auswaehlen...",
    "subsectorLabel": "Teilsektor",
    "subsectorPlaceholder": "Teilsektor auswaehlen...",
    "anlage1Group": "Sektoren hoher Kritikalitaet (Anlage 1)",
    "anlage2Group": "Sonstige kritische Sektoren (Anlage 2)",
    "notListed": "Mein Sektor ist nicht aufgefuehrt",
    "sectorRequired": "Bitte waehlen Sie einen Sektor aus"
  },
  "sizeStep": {
    "title": "Wie gross ist Ihr Unternehmen?",
    "employeesLabel": "Anzahl Mitarbeiter",
    "employeesPlaceholder": "z.B. 120",
    "revenueLabel": "Jahresumsatz (EUR)",
    "revenuePlaceholder": "z.B. 15.000.000",
    "balanceSheetLabel": "Bilanzsumme (EUR)",
    "balanceSheetOptional": "(optional)",
    "balanceSheetTooltip": "Falls bekannt, bitte angeben. Wenn nicht, wird nur der Umsatz fuer die Klassifizierung verwendet.",
    "balanceSheetPlaceholder": "z.B. 12.000.000",
    "kritisLabel": "Betreiben Sie kritische Infrastruktur (KRITIS)?",
    "kritisTooltip": "KRITIS-Betreiber sind unabhaengig von der Unternehmensgroesse als besonders wichtige Einrichtung eingestuft (Par. 28 Abs. 1 Nr. 1 BSIG). Betrifft z.B. Energieversorger, grosse Wasserwerke oder Krankenhaeuser.",
    "employeesRequired": "Bitte geben Sie die Mitarbeiterzahl an",
    "revenueRequired": "Bitte geben Sie den Jahresumsatz an"
  },
  "resultStep": {
    "title": "Ihr Ergebnis",
    "besondersWichtig": "Besonders wichtige Einrichtung",
    "wichtig": "Wichtige Einrichtung",
    "nichtBetroffen": "Voraussichtlich nicht von NIS2 betroffen",
    "whyTitle": "Warum diese Einstufung?",
    "legalBasis": "Rechtsgrundlage",
    "supplyChainTitle": "Hinweis zur Lieferkettensicherheit",
    "supplyChainText": "Auch wenn Sie nicht direkt von NIS2 betroffen sind, koennen Ihre Kunden oder Auftraggeber als NIS2-regulierte Einrichtungen Sicherheitsanforderungen an Sie als Lieferant stellen (Art. 21(2)(d), Par. 30 Abs. 2 Nr. 4 BSIG).",
    "ctaPrimary": "Reifegrad pruefen",
    "ctaSecondary": "Erneut pruefen"
  },
  "navigation": {
    "next": "Weiter",
    "back": "Zurueck",
    "submit": "Ergebnis anzeigen"
  }
}
```

IMPORTANT: Use proper German Umlauts (ae -> ä, oe -> ö, ue -> ü) in the actual JSON file. The above uses ASCII-safe representations for readability. In the actual file write: "Prüfen", "größe", "wählen", "nächsten", etc. Copy the style from the existing de.json translations which already use proper Umlauts.

English (`en.json`) - add equivalent `"check"` key with English translations:
```json
"check": {
  "title": "NIS2 Affected Check",
  "subtitle": "Check in a few steps whether your company is affected by NIS2",
  "steps": {
    "sector": "Sector",
    "companySize": "Company Size",
    "result": "Result"
  },
  "sectorStep": {
    "title": "In which sector does your company operate?",
    "sectorLabel": "Sector",
    "sectorPlaceholder": "Select a sector...",
    "subsectorLabel": "Subsector",
    "subsectorPlaceholder": "Select a subsector...",
    "anlage1Group": "Sectors of High Criticality (Annex 1)",
    "anlage2Group": "Other Critical Sectors (Annex 2)",
    "notListed": "My sector is not listed",
    "sectorRequired": "Please select a sector"
  },
  "sizeStep": {
    "title": "How large is your company?",
    "employeesLabel": "Number of Employees",
    "employeesPlaceholder": "e.g. 120",
    "revenueLabel": "Annual Revenue (EUR)",
    "revenuePlaceholder": "e.g. 15,000,000",
    "balanceSheetLabel": "Balance Sheet Total (EUR)",
    "balanceSheetOptional": "(optional)",
    "balanceSheetTooltip": "If known, please provide. If not, only revenue will be used for classification.",
    "balanceSheetPlaceholder": "e.g. 12,000,000",
    "kritisLabel": "Do you operate critical infrastructure (KRITIS)?",
    "kritisTooltip": "KRITIS operators are classified as particularly important entities regardless of company size (Sec. 28(1)(1) BSIG). This applies to e.g. energy suppliers, large water utilities, or hospitals.",
    "employeesRequired": "Please enter the number of employees",
    "revenueRequired": "Please enter the annual revenue"
  },
  "resultStep": {
    "title": "Your Result",
    "besondersWichtig": "Particularly Important Entity",
    "wichtig": "Important Entity",
    "nichtBetroffen": "Presumably Not Affected by NIS2",
    "whyTitle": "Why this classification?",
    "legalBasis": "Legal Basis",
    "supplyChainTitle": "Supply Chain Security Notice",
    "supplyChainText": "Even if you are not directly affected by NIS2, your customers or clients as NIS2-regulated entities may impose security requirements on you as a supplier (Art. 21(2)(d), Sec. 30(2)(4) BSIG).",
    "ctaPrimary": "Check Readiness Level",
    "ctaSecondary": "Check Again"
  },
  "navigation": {
    "next": "Next",
    "back": "Back",
    "submit": "Show Result"
  }
}
```

When modifying the JSON files, preserve ALL existing keys exactly. Add the `"check"` key as a new top-level entry. Do not change any existing translations.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify TypeScript compiles without errors.
2. Verify wizard-store.ts imports ClassificationInput and uses persist middleware.
3. Verify step-indicator.tsx exports StepIndicator component.
4. Verify navigation.tsx exports WizardNavigation component.
5. Verify de.json and en.json both contain `"check"` key with all subkeys.
6. Run `npm run build` to verify no build errors.
  </verify>
  <done>
- wizard-store.ts extended with formData (Partial ClassificationInput), persist middleware (key: nis2-wizard-storage), navigation actions (nextStep, prevStep, updateFormData, reset)
- StepIndicator component renders 3 numbered circles with active/completed/upcoming states and connecting lines
- WizardNavigation component renders Back/Next buttons with correct type attributes (button/submit)
- Both de.json and en.json contain check.steps, check.sectorStep, check.sizeStep, check.resultStep, check.navigation translations
- TypeScript compiles, build succeeds
  </done>
</task>

</tasks>

<verification>
1. `npm ls react-hook-form zod react-number-format @hookform/resolvers` -- all installed
2. `ls src/components/ui/` -- 8 files (button, card, select, input, label, tooltip, checkbox, separator)
3. `npx tsc --noEmit` -- no TypeScript errors
4. `npm run build` -- build succeeds
5. Wizard store uses `persist` middleware with `nis2-wizard-storage` key
6. StepIndicator renders with aria-label for accessibility
7. Both JSON files parse without errors and contain `check` key
</verification>

<success_criteria>
- All npm dependencies installed and importable
- All 6 shadcn components exist in src/components/ui/
- Wizard store extends current store with formData persistence and step navigation
- StepIndicator and WizardNavigation components exist and are importable
- DE and EN translation files contain all check wizard text
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-affected-check/03-01-SUMMARY.md`
</output>
