---
phase: 06-pdf-report
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/pdf/PDFDocument.tsx
  - src/components/pdf/PDFCoverPage.tsx
  - src/components/pdf/PDFCompanyProfile.tsx
  - src/components/pdf/PDFOverallScore.tsx
  - src/components/pdf/PDFScoresTable.tsx
  - src/components/pdf/PDFRecommendations.tsx
  - src/lib/pdf/styles.ts
  - src/app/[locale]/results/components/download-pdf-button.tsx
  - src/messages/de.json
  - src/messages/en.json
  - src/stores/wizard-store.ts
autonomous: true

must_haves:
  truths:
    - "PDF contains company profile section with sector name, employee count, revenue, and NIS2 classification"
    - "PDF shows all 10 category scores with traffic-light colored dots and percentage bars"
    - "PDF contains prioritized recommendations sorted by urgency with legal references and BSI references"
    - "PDF has legal disclaimer on the first page with conditional language"
    - "PDF shows Rechtsstand-Datum (Januar 2025) and Erstellungsdatum on every page"
    - "PDF generates in the user's selected language (German or English)"
    - "Legal references (Art. 21, par. 30 BSIG) appear in German original even in English PDF"
  artifacts:
    - path: "src/components/pdf/PDFCoverPage.tsx"
      provides: "Cover page with title, disclaimer, dates"
      contains: "Rechtsstand"
    - path: "src/components/pdf/PDFCompanyProfile.tsx"
      provides: "Company profile section"
      contains: "sectorName"
    - path: "src/components/pdf/PDFOverallScore.tsx"
      provides: "Overall Reifegrad display with traffic light"
      contains: "overallScore"
    - path: "src/components/pdf/PDFScoresTable.tsx"
      provides: "10-category scores table with traffic lights and bars"
      contains: "categories.map"
    - path: "src/components/pdf/PDFRecommendations.tsx"
      provides: "Recommendations section with legal refs"
      contains: "recommendations"
    - path: "src/components/pdf/PDFDocument.tsx"
      provides: "Composed document using all sub-components"
      contains: "PDFCoverPage"
  key_links:
    - from: "src/components/pdf/PDFDocument.tsx"
      to: "src/components/pdf/PDFCoverPage.tsx"
      via: "component composition"
      pattern: "PDFCoverPage"
    - from: "src/components/pdf/PDFDocument.tsx"
      to: "src/components/pdf/PDFScoresTable.tsx"
      via: "component composition"
      pattern: "PDFScoresTable"
    - from: "src/components/pdf/PDFDocument.tsx"
      to: "src/components/pdf/PDFRecommendations.tsx"
      via: "component composition"
      pattern: "PDFRecommendations"
    - from: "src/app/[locale]/results/components/download-pdf-button.tsx"
      to: "src/stores/wizard-store.ts"
      via: "reads classification result for company profile"
      pattern: "useWizardStore|classificationResult"
    - from: "src/components/pdf/PDFRecommendations.tsx"
      to: "legal references"
      via: "legalReference field always in German"
      pattern: "legalReference"
---

<objective>
Replace the PDF skeleton from Plan 01 with professional, production-quality content components: cover page with legal disclaimer, company profile with NIS2 classification, overall score visualization, 10-category scores table with traffic lights, and prioritized recommendations with legal + BSI references. Add i18n translations for all PDF text. Fix company profile data flow by storing classification result in wizard store.

Purpose: This transforms the working-but-skeleton PDF into the professional report that fulfills all PDF requirements (PDF-01 through PDF-06, I18N-04, I18N-05).

Output: A complete, professionally formatted PDF report that a KMU can hand to their management or auditor.
</objective>

<execution_context>
@C:\Users\mjoan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mjoan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-pdf-report/06-RESEARCH.md
@.planning/phases/06-pdf-report/06-01-SUMMARY.md

Key source files:
@src/lib/nis2/types.ts
@src/lib/nis2/categories.ts
@src/lib/nis2/recommendations.ts
@src/lib/scoring/engine.ts
@src/lib/pdf/types.ts
@src/lib/pdf/styles.ts
@src/components/pdf/PDFDocument.tsx
@src/app/[locale]/results/components/download-pdf-button.tsx
@src/app/[locale]/results/page.tsx
@src/stores/wizard-store.ts
@src/app/[locale]/check/steps/result.tsx
@src/messages/de.json
@src/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Store classification result, add PDF translations, create cover page and company profile components</name>
  <files>
    src/stores/wizard-store.ts
    src/messages/de.json
    src/messages/en.json
    src/components/pdf/PDFCoverPage.tsx
    src/components/pdf/PDFCompanyProfile.tsx
    src/components/pdf/PDFOverallScore.tsx
    src/lib/pdf/styles.ts
    src/app/[locale]/results/components/download-pdf-button.tsx
  </files>
  <action>
1. Update `src/stores/wizard-store.ts` to store classification result:
   The wizard store currently stores only `formData: Partial<ClassificationInput>`. The classification result (category, reason, legalReference) is computed in the result step but not stored anywhere persistent. Add a `classificationResult` field.

   Add to the WizardState interface:
   ```typescript
   import { ClassificationInput, ClassificationResult } from '@/lib/nis2/types';

   interface WizardState {
     // ... existing fields
     classificationResult: ClassificationResult | null;
     setClassificationResult: (result: ClassificationResult) => void;
     // ... existing actions
   }
   ```

   Add to the store implementation:
   ```typescript
   classificationResult: null,
   setClassificationResult: (result) => set({ classificationResult: result }),
   ```

   Add `classificationResult` to the `partialize` function so it persists to localStorage.

   Then update `src/app/[locale]/check/steps/result.tsx` to call `setClassificationResult()` when the classification is computed. Read the result.tsx file first to understand its structure -- it likely computes the classification via `classify()` and displays it. Add a useEffect or inline call to store the result.

2. Add PDF section to `src/messages/de.json` -- add a new top-level `"pdf"` key:
   ```json
   "pdf": {
     "title": "NIS2-Readiness-Report",
     "subtitle": "Ergebnis der NIS2-Bereitschaftsprüfung",
     "disclaimer": "Haftungsausschluss: Ihre Angaben deuten darauf hin, dass der folgende Reifegrad vorliegt. Ein hoher Score bedeutet nicht automatisch NIS2-Konformität. Jede Maßnahme muss angemessen, verhältnismäßig und wirksam für Ihr spezifisches Risikoprofil umgesetzt sein (§30 Abs. 1 BSIG). Diese Auswertung dient ausschließlich als Orientierungshilfe und ersetzt keine Rechtsberatung oder professionelle Sicherheitsbewertung.",
     "companyProfile": "Unternehmensprofil",
     "sector": "Sektor",
     "subsector": "Teilsektor",
     "employees": "Beschäftigte",
     "revenue": "Jahresumsatz",
     "classification": "NIS2-Einstufung",
     "legalBasis": "Rechtsgrundlage",
     "overallScore": "Gesamter Reifegrad",
     "completionRate": "Abschlussrate",
     "questionsAnswered": "{answered} von {total} Fragen beantwortet",
     "categories": "Ergebnisse nach Maßnahmenbereich",
     "categoryHeader": "Maßnahmenbereich",
     "scoreHeader": "Score",
     "statusHeader": "Status",
     "legalRefHeader": "Rechtsgrundlage",
     "recommendations": "Handlungsempfehlungen",
     "sortedByUrgency": "Sortiert nach Dringlichkeit — Bereiche mit Handlungsbedarf zuerst",
     "firstStep": "Nächster Schritt",
     "priority": "Priorität",
     "priorityHigh": "Hoch",
     "priorityMedium": "Mittel",
     "priorityLow": "Niedrig",
     "effort": "Aufwand",
     "effortQuick": "Schnell umsetzbar",
     "effortMedium": "Mittelfristig",
     "effortStrategic": "Strategisch",
     "legalRef": "Rechtsgrundlage",
     "bsiRef": "BSI-Grundschutz",
     "generatedAt": "Erstellt am",
     "legalDate": "Rechtsstand: Januar 2025 (NIS2-Richtlinie (EU) 2022/2555, NIS2UmsG)",
     "trafficLightRed": "Handlungsbedarf",
     "trafficLightYellow": "Verbesserung nötig",
     "trafficLightGreen": "Gut umgesetzt",
     "generating": "PDF wird erstellt...",
     "downloadError": "PDF-Erstellung fehlgeschlagen. Bitte versuchen Sie es erneut.",
     "legalRefNote": ""
   }
   ```

   Add equivalent `"pdf"` section to `src/messages/en.json`:
   ```json
   "pdf": {
     "title": "NIS2 Readiness Report",
     "subtitle": "NIS2 Readiness Assessment Results",
     "disclaimer": "Disclaimer: Your responses indicate the following maturity level. A high score does not automatically mean NIS2 compliance. Every measure must be adequately, proportionately, and effectively implemented for your specific risk profile (§30 Abs. 1 BSIG). This assessment serves as guidance only and does not replace legal advice or professional security assessment.",
     "companyProfile": "Company Profile",
     "sector": "Sector",
     "subsector": "Subsector",
     "employees": "Employees",
     "revenue": "Annual Revenue",
     "classification": "NIS2 Classification",
     "legalBasis": "Legal Basis",
     "overallScore": "Overall Readiness Score",
     "completionRate": "Completion Rate",
     "questionsAnswered": "{answered} of {total} questions answered",
     "categories": "Results by Measure Category",
     "categoryHeader": "Measure Category",
     "scoreHeader": "Score",
     "statusHeader": "Status",
     "legalRefHeader": "Legal Reference",
     "recommendations": "Recommendations",
     "sortedByUrgency": "Sorted by urgency — areas requiring action first",
     "firstStep": "Next Step",
     "priority": "Priority",
     "priorityHigh": "High",
     "priorityMedium": "Medium",
     "priorityLow": "Low",
     "effort": "Effort",
     "effortQuick": "Quick to implement",
     "effortMedium": "Medium-term",
     "effortStrategic": "Strategic",
     "legalRef": "Legal Reference",
     "bsiRef": "BSI IT-Grundschutz",
     "generatedAt": "Generated on",
     "legalDate": "Legal status: January 2025 (NIS2 Directive (EU) 2022/2555, NIS2UmsG)",
     "trafficLightRed": "Action Required",
     "trafficLightYellow": "Improvement Needed",
     "trafficLightGreen": "Well Implemented",
     "generating": "Generating PDF...",
     "downloadError": "PDF generation failed. Please try again.",
     "legalRefNote": "(Original German text, as legally required)"
   }
   ```

   Also update the results.actions section in both files:
   - de.json: Remove `"pdfComingSoon": "Verfügbar in Kürze"` (no longer needed)
   - en.json: Remove equivalent key

3. Create `src/components/pdf/PDFCoverPage.tsx`:
   A professional cover page with:
   - Title (large, blue primary)
   - Subtitle
   - Horizontal rule
   - Disclaimer box (gray background, border, small text)
   - Rechtsstand-Datum: "Rechtsstand: Januar 2025 (NIS2-Richtlinie (EU) 2022/2555, NIS2UmsG)" -- ALWAYS in German even in English PDF, since it's a legal reference
   - Erstellungsdatum: formatted in user's locale (e.g., "7. Februar 2026" for de, "7 February 2026" for en)
   - Use `Intl.DateTimeFormat` for locale-aware date formatting

   Props: `{ messages: PDFMessages; locale: 'de' | 'en'; generatedDate: string }`

   The disclaimer text must use conditional language: "Ihre Angaben deuten darauf hin..." (already in the translation).

4. Create `src/components/pdf/PDFCompanyProfile.tsx`:
   Display company data in a structured layout:
   - Section title: "Unternehmensprofil" / "Company Profile"
   - Rows: Sektor, Teilsektor (if exists), Beschaeftigte, Jahresumsatz (formatted with Intl.NumberFormat), NIS2-Einstufung (with colored badge), Rechtsgrundlage
   - The classification should be visually prominent (bold, colored by category)
   - Revenue formatting: use `new Intl.NumberFormat(locale, { style: 'currency', currency: 'EUR' })` for locale-aware EUR formatting

   Props: `{ company: PDFCompanyProfile; messages: PDFMessages; locale: 'de' | 'en' }`

   Use flex rows with label-value pairs. Label in gray500, value in gray900 bold.

5. Create `src/components/pdf/PDFOverallScore.tsx`:
   Display the overall Reifegrad:
   - Large percentage number (24pt, bold, colored by traffic light)
   - Traffic light dot next to it
   - Label: "Gesamter Reifegrad" / "Overall Readiness Score"
   - Completion rate text below: "27 von 30 Fragen beantwortet"
   - Background: subtle colored box matching traffic light

   Props: `{ overallScore: PDFPayload['overallScore']; messages: PDFMessages }`

6. Update `src/lib/pdf/styles.ts`:
   Add new styles needed by the content components:
   - `coverTitle`: 26pt bold primary
   - `coverSubtitle`: 13pt gray500
   - `horizontalRule`: 1px gray200 border-bottom
   - `profileRow`: flex row with label/value
   - `profileLabel`: 10pt gray500
   - `profileValue`: 10pt gray900 bold
   - `overallScoreContainer`: centered box with colored background
   - `overallScoreValue`: 28pt bold
   - `tableRow`, `tableCell`, `tableHeader`: for category scores
   - `recCard`: recommendation card with border-left color
   - `recTitle`: bold 10pt
   - `recDescription`: 9pt gray700
   - `recMeta`: 8pt gray500 (legal refs, BSI refs)
   - `badge`: small rounded label (for effort level, priority)

7. Update `src/app/[locale]/results/components/download-pdf-button.tsx`:
   - Read `classificationResult` from wizard store (added in step 1)
   - Use it to populate `company.classification`, `company.classificationCategory`, and `company.legalReference` with actual data instead of placeholders
   - Use `tPdf = useTranslations('pdf')` to populate messages from the new pdf translation section instead of hardcoded strings
   - Fix the translation key resolution to use the correct nested key patterns (verify against the actual i18n structure)
   - For classification display text, use: classificationResult.category mapped to tClassification('categories.besondersWichtig') etc.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (TypeScript compilation)
    - Wizard store now has classificationResult field
    - de.json and en.json have `pdf` section with all required keys
    - PDF components compile: PDFCoverPage.tsx, PDFCompanyProfile.tsx, PDFOverallScore.tsx
    - Download button reads classification from wizard store
  </verify>
  <done>
    Cover page shows disclaimer with conditional language, Rechtsstand-Datum and Erstellungsdatum. Company profile shows all data fields with proper formatting. Overall score displays with traffic-light coloring. PDF translations exist in both languages. Classification result persists in wizard store.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scores table, recommendations section, compose final PDFDocument</name>
  <files>
    src/components/pdf/PDFScoresTable.tsx
    src/components/pdf/PDFRecommendations.tsx
    src/components/pdf/PDFDocument.tsx
  </files>
  <action>
1. Create `src/components/pdf/PDFScoresTable.tsx`:
   Table showing all 10 NIS2 Art. 21(2) categories with scores.

   Use `@ag-media/react-pdf-table` for the table layout (Table, TableHeader, TableCell, TableBody, TableRow, DataTableCell).

   If @ag-media/react-pdf-table causes issues (compatibility with react-pdf 4.x), fall back to manual flex-based table rows using View components with flexDirection: 'row'.

   Table columns:
   | Nr. | Massnahmenbereich | Score | Status | Rechtsgrundlage |
   - Nr.: Sequential number (1-10)
   - Massnahmenbereich: Category short name (translated)
   - Score: Percentage with visual bar (View with colored fill inside gray background)
   - Status: Traffic light dot + status text ("Handlungsbedarf" / "Verbesserung noetig" / "Gut umgesetzt")
   - Rechtsgrundlage: EU article + BSIG paragraph (ALWAYS in German, even in English PDF)

   Traffic light implementation:
   - Use View with borderRadius: "50%" (circle) and backgroundColor set to red (#dc2626), yellow (#ca8a04), or green (#16a34a)
   - Next to it, show the score bar: gray background View containing a colored fill View whose width is `${percentage}%`
   - WARNING: react-pdf percentage widths may not work directly. Use fractional flex values or calculate absolute widths based on available space. Test if `width: '67%'` works in react-pdf -- if not, use `flex: 0.67` approach.

   Score bar implementation:
   ```
   <View style={{ flexDirection: 'row', alignItems: 'center', gap: 4 }}>
     <View style={{ width: 80, height: 8, backgroundColor: '#e5e7eb', borderRadius: 4 }}>
       <View style={{
         width: `${Math.min(percentage, 100)}%`,
         height: 8,
         backgroundColor: trafficLightColor,
         borderRadius: 4,
       }} />
     </View>
     <Text style={{ fontSize: 9, fontWeight: 700 }}>{percentage}%</Text>
   </View>
   ```

   Legal references column: Show "Art. 21(2)(a)" and "par. 30 Abs. 2 Nr. 1 BSIG" on two lines. These MUST remain in German original even when locale is 'en'. In English PDF, add a small note below the table: "(Original German text, as legally required)" using the `pdf.legalRefNote` translation.

   Props: `{ categories: PDFCategoryResult[]; messages: PDFMessages; locale: 'de' | 'en' }`

2. Create `src/components/pdf/PDFRecommendations.tsx`:
   List of recommendations grouped by category, sorted by urgency (red categories first).

   Structure for each recommendation:
   ```
   [Category Name - colored by traffic light]
   [Rec Title] (bold)                     [Priority badge] [Effort badge]
   [Description] (gray text)
   Naechster Schritt: [First step text] (slightly indented, italic-style with left border)
   Rechtsgrundlage: [legal ref]  |  BSI-Grundschutz: [bsi ref]
   --- separator ---
   ```

   Implementation details:
   - Category header: Show category name with a colored left border (4pt) matching traffic light color
   - Priority badge: Small View with background color and text ("Hoch" / "Mittel" / "Niedrig")
   - Effort badge: Small View with background color and text ("Schnell umsetzbar" / "Mittelfristig" / "Strategisch")
   - Legal references: ALWAYS in German original. Format: "Art. 21(2)(a), par. 30 Abs. 2 Nr. 1 BSIG" and "BSI-Standard 200-3, ISMS.1"
   - In English PDF, legal refs stay German with note

   Group recommendations by category. Within each category, sort by priority (high first).

   Handle page breaks: Add `break` prop or `minPresenceAhead` on each recommendation card to avoid splitting a single recommendation across pages.

   Props: `{ recommendations: PDFRecommendation[]; messages: PDFMessages; locale: 'de' | 'en' }`

3. Rewrite `src/components/pdf/PDFDocument.tsx`:
   Replace the skeleton content from Plan 01 with composed sub-components.

   Page structure:
   - **Page 1:** Cover page (PDFCoverPage) + Company Profile (PDFCompanyProfile) + Overall Score (PDFOverallScore)
   - **Page 2:** Category Scores Table (PDFScoresTable) -- may flow to page 3 if table is large
   - **Page 3+:** Recommendations (PDFRecommendations) -- may span multiple pages

   Use `break` or `wrap={false}` on page-level sections to control page breaks.

   Each page gets:
   - Fixed footer with "NIS2-Bereitschaftspruefung" on left, page "X / Y" on right
   - Consistent padding (40pt all sides)
   - Inter font family

   The Document component should set metadata:
   ```typescript
   <Document
     title={messages['pdf.title']}
     author="NIS2-Bereitschaftsprüfung"
     subject="NIS2 Readiness Assessment"
     creator="NIS2-Bereitschaftsprüfung"
   >
   ```

   Import all sub-components and compose:
   ```typescript
   import PDFCoverPage from './PDFCoverPage';
   import PDFCompanyProfile from './PDFCompanyProfile';
   import PDFOverallScore from './PDFOverallScore';
   import PDFScoresTable from './PDFScoresTable';
   import PDFRecommendations from './PDFRecommendations';
   ```

   IMPORTANT: Ensure the total page count stays manageable (3-5 pages) for the Vercel 10-second timeout. The 10 categories + 20 recommendations should fit in 4-5 pages with the current styling.
  </action>
  <verify>
    1. `npm run build` completes without errors
    2. `npm run dev` -- click PDF download on results page
    3. PDF verification checklist:
       - Page 1: Title "NIS2-Readiness-Report", disclaimer box, Rechtsstand + Erstellungsdatum, company profile section, overall score with colored percentage
       - Page 2: Category scores table with 10 rows, each showing: number, category name, score bar with color, traffic light status text, legal reference in German
       - Page 3+: Recommendations sorted by urgency, each with title, description, first step, priority/effort badges, legal + BSI references in German
       - All pages: Footer with "NIS2-Bereitschaftspruefung" and page numbers
       - German Umlaute render correctly everywhere (ae, oe, ue, ss)
    4. Switch to English locale, download PDF:
       - UI text is in English
       - Legal references remain in German original
       - English PDF shows note "(Original German text, as legally required)" near legal refs
    5. File size: PDF should be under 500KB
    6. Generation time: Under 10 seconds (check Vercel/dev server logs)
  </verify>
  <done>
    Professional PDF report with: cover page (disclaimer, dates), company profile (sector, size, classification), overall Reifegrad score, 10-category scores table with traffic lights, prioritized recommendations with legal + BSI references. Works in both German and English. Legal references always in German original. Renders within Vercel timeout.
  </done>
</task>

</tasks>

<verification>
Complete verification against all Phase 6 requirements:

1. **PDF-01** (downloadable report): User clicks button, receives PDF file
2. **PDF-02** (complete content): PDF contains company profile, 10 category scores with traffic lights, recommendations, legal references
3. **PDF-03** (disclaimer on first page): Cover page has disclaimer box with conditional language
4. **PDF-04** (Rechtsstand + Erstellungsdatum): Both dates visible on cover page
5. **PDF-05** (German Umlaute): Inter font renders ae, oe, ue, ss correctly
6. **PDF-06** (Vercel serverless): Pages Router API generates PDF within 10 seconds
7. **I18N-04** (language selection): PDF generates in user's selected language (de or en)
8. **I18N-05** (legal refs in German): Art. 21, par. 28/30 BSIG always shown in German original

Test procedure:
1. Complete full flow: affected check -> gap analysis (all 30 questions) -> results
2. Download PDF in German -- verify all content and formatting
3. Switch to English, download PDF -- verify English text with German legal refs
4. Open both PDFs in multiple viewers (browser, Adobe, Preview) -- no rendering issues
5. Check file sizes (should be under 500KB each)
</verification>

<success_criteria>
- PDF has professional formatting suitable for management/auditor presentation
- All 10 categories displayed with traffic-light scores and percentage bars
- Recommendations sorted by urgency with actionable first steps
- Legal disclaimer present on first page with conditional language
- Rechtsstand-Datum and Erstellungsdatum visible
- German Umlaute render correctly throughout
- Both German and English PDFs generate correctly
- Legal references always in German original (even in English PDF)
- Generation completes under 10 seconds
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-pdf-report/06-02-SUMMARY.md`
</output>
