---
phase: 04-gap-analysis-wizard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/radio-group.tsx
  - src/stores/gap-analysis-store.ts
  - src/messages/de.json
  - src/messages/en.json
  - src/app/[locale]/gap-analysis/page.tsx
  - src/app/[locale]/gap-analysis/components/category-progress.tsx
  - src/app/[locale]/gap-analysis/steps/category-step.tsx
autonomous: true

must_haves:
  truths:
    - "User progresses through 10 category steps answering 3 questions each via 4-level maturity radio buttons"
    - "Progress indicator shows current category name and number (Bereich X von 10) plus overall completion percentage"
    - "User navigates backward and forward between categories without any answers being lost"
    - "Answers persist in localStorage and survive page refresh"
    - "After completing last category, user is navigated to /results"
  artifacts:
    - path: "src/stores/gap-analysis-store.ts"
      provides: "Gap analysis state management with answer persistence"
      exports: ["useGapAnalysisStore"]
    - path: "src/app/[locale]/gap-analysis/page.tsx"
      provides: "Gap analysis wizard container with hydration guard"
      min_lines: 30
    - path: "src/app/[locale]/gap-analysis/components/category-progress.tsx"
      provides: "Dual progress display: category counter + percentage bar"
      min_lines: 20
    - path: "src/app/[locale]/gap-analysis/steps/category-step.tsx"
      provides: "Generic category step rendering 3 questions with RadioGroup"
      min_lines: 80
    - path: "src/components/ui/radio-group.tsx"
      provides: "shadcn/ui RadioGroup component"
  key_links:
    - from: "src/app/[locale]/gap-analysis/page.tsx"
      to: "src/stores/gap-analysis-store.ts"
      via: "useGapAnalysisStore for currentCategoryIndex and answers"
      pattern: "useGapAnalysisStore"
    - from: "src/app/[locale]/gap-analysis/steps/category-step.tsx"
      to: "src/stores/gap-analysis-store.ts"
      via: "updateAnswers and navigation actions"
      pattern: "updateAnswers|nextCategory|prevCategory"
    - from: "src/app/[locale]/gap-analysis/steps/category-step.tsx"
      to: "src/lib/nis2/questions.ts"
      via: "QUESTIONS data for rendering"
      pattern: "getQuestionsByCategory|QUESTIONS"
    - from: "src/app/[locale]/gap-analysis/page.tsx"
      to: "src/lib/nis2/categories.ts"
      via: "CATEGORIES array for step indexing"
      pattern: "CATEGORIES"
    - from: "src/app/[locale]/check/steps/result.tsx"
      to: "/gap-analysis"
      via: "Link href to gap analysis page"
      pattern: "href.*gap-analysis"
---

<objective>
Build the complete Gap Analysis Wizard UI -- a 10-step form where users assess their NIS2 maturity across all Art. 21(2) measure categories by answering 3 questions per category using a 4-level maturity scale.

Purpose: This is the core assessment engine UI. Users who passed the affected check (Phase 3) land here to evaluate their actual NIS2 readiness. Their answers feed the scoring engine (Phase 2) which produces the results dashboard (Phase 5).

Output: Working gap analysis wizard at /gap-analysis with zustand-persisted answers, category navigation, progress indicator, and maturity RadioGroup selections.
</objective>

<execution_context>
@C:\Users\mjoan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mjoan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gap-analysis-wizard/04-RESEARCH.md

Key source files to reference for patterns:
@src/stores/wizard-store.ts
@src/app/[locale]/check/page.tsx
@src/app/[locale]/check/components/navigation.tsx
@src/app/[locale]/check/components/step-indicator.tsx
@src/app/[locale]/check/steps/result.tsx
@src/lib/nis2/types.ts
@src/lib/nis2/categories.ts
@src/lib/nis2/questions.ts
@src/messages/de.json
@src/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Store, RadioGroup component, and i18n translations</name>
  <files>
    src/components/ui/radio-group.tsx
    src/stores/gap-analysis-store.ts
    src/messages/de.json
    src/messages/en.json
  </files>
  <action>
**1. Add shadcn/ui RadioGroup component:**

Run `npx shadcn@latest add radio-group` to scaffold `src/components/ui/radio-group.tsx`. The `radix-ui` monorepo package (v1.4.3) is already installed so no new npm dependency is needed -- the CLI just creates the component file. If the CLI fails or asks for interactive input, manually create the file following the shadcn/ui RadioGroup pattern using `@radix-ui/react-radio-group` primitives from the `radix-ui` package, with `RadioGroup` and `RadioGroupItem` exports styled with Tailwind classes.

**2. Create gap-analysis-store.ts:**

Create `src/stores/gap-analysis-store.ts` following the exact pattern from `src/stores/wizard-store.ts`:
- Import `create` from `zustand` and `persist` from `zustand/middleware`
- Import `Answer` and `MaturityLevel` from `@/lib/nis2/types`
- Interface `GapAnalysisState` with:
  - `currentCategoryIndex: number` (0-9)
  - `answers: Answer[]` (flat array of all answers across all categories)
  - `setCategoryIndex: (index: number) => void`
  - `nextCategory: () => void` (clamp at 9)
  - `prevCategory: () => void` (clamp at 0)
  - `updateAnswers: (categoryAnswers: Answer[]) => void` -- merge strategy: filter out existing answers with matching questionId, then spread new ones in
  - `getAnswersByCategory: (categoryId: string) => Answer[]`
  - `getAnsweredCount: () => number` -- returns `answers.length`
  - `reset: () => void`
- Persist config: `name: 'nis2-gap-analysis-storage'`, partialize to persist only `answers` and `currentCategoryIndex`
- Export `useGapAnalysisStore`

**3. Add gapAnalysis i18n translations:**

Add a top-level `gapAnalysis` key to both `src/messages/de.json` and `src/messages/en.json`:

```json
"gapAnalysis": {
  "title": "NIS2 Gap-Analyse",
  "subtitle": "Bewerten Sie Ihren Umsetzungsstand in den 10 Maßnahmenbereichen nach Art. 21(2) NIS2-Richtlinie",
  "progress": {
    "category": "Bereich {current} von {total}",
    "overall": "Gesamtfortschritt",
    "detail": "{answered} von {total} Fragen beantwortet",
    "percentage": "{value}%"
  },
  "navigation": {
    "back": "Zurück",
    "next": "Weiter",
    "showResults": "Ergebnisse anzeigen"
  },
  "question": {
    "selectMaturity": "Wählen Sie den aktuellen Umsetzungsstand:",
    "tooltip": "Erläuterung"
  },
  "maturityOptions": {
    "level0": "Stufe 0: {description}",
    "level1": "Stufe 1: {description}",
    "level2": "Stufe 2: {description}",
    "level3": "Stufe 3: {description}"
  }
}
```

For English (`en.json`), translate accordingly:
```json
"gapAnalysis": {
  "title": "NIS2 Gap Analysis",
  "subtitle": "Assess your implementation status across the 10 measure categories per Art. 21(2) NIS2 Directive",
  "progress": {
    "category": "Category {current} of {total}",
    "overall": "Overall progress",
    "detail": "{answered} of {total} questions answered",
    "percentage": "{value}%"
  },
  "navigation": {
    "back": "Back",
    "next": "Next",
    "showResults": "Show results"
  },
  "question": {
    "selectMaturity": "Select the current implementation level:",
    "tooltip": "Explanation"
  },
  "maturityOptions": {
    "level0": "Level 0: {description}",
    "level1": "Level 1: {description}",
    "level2": "Level 2: {description}",
    "level3": "Level 3: {description}"
  }
}
```

IMPORTANT: Preserve ALL existing keys in both JSON files. Only ADD the `gapAnalysis` key. Read the full file first, add the key, write it back. Do NOT truncate or lose existing translations.
  </action>
  <verify>
1. `src/components/ui/radio-group.tsx` exists and exports `RadioGroup` and `RadioGroupItem`
2. `src/stores/gap-analysis-store.ts` compiles: run `npx tsc --noEmit src/stores/gap-analysis-store.ts` or verify no red squiggles
3. Both de.json and en.json have the `gapAnalysis` key AND all previous keys still exist (spot-check: `questions`, `categories`, `check` keys must still be present)
4. Run `npm run build` -- should compile without errors (new files have no consumers yet, but imports must resolve)
  </verify>
  <done>
- RadioGroup component available at src/components/ui/radio-group.tsx
- Gap analysis store created with persist middleware, separate localStorage key (nis2-gap-analysis-storage), answer merge strategy, and category navigation
- Both language files have gapAnalysis translations for progress, navigation, and maturity option labels
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Gap analysis wizard page, progress indicator, and category step</name>
  <files>
    src/app/[locale]/gap-analysis/page.tsx
    src/app/[locale]/gap-analysis/components/category-progress.tsx
    src/app/[locale]/gap-analysis/steps/category-step.tsx
  </files>
  <action>
**1. Create CategoryProgress component:**

Create `src/app/[locale]/gap-analysis/components/category-progress.tsx`:
- Props: `currentIndex: number`, `totalCategories: number`, `categoryName: string`, `answeredCount: number`, `totalQuestions: number`
- Renders two sections:
  - **Category counter:** Text showing `t('progress.category', { current: currentIndex + 1, total: totalCategories })` then the category name as an `<h2>` with `aria-current="step"`
  - **Progress bar:** A styled `<div>` with `role="progressbar"`, `aria-valuenow`, `aria-valuemin={0}`, `aria-valuemax={100}`, `aria-label={t('progress.overall')}`, showing the percentage visually as a blue bar (`bg-blue-700` matching the design system). Text shows `{percentage}%` on the right.
  - A screen-reader-only `<span className="sr-only">` with `t('progress.detail', { answered: answeredCount, total: totalQuestions })`
- Use `useTranslations('gapAnalysis')` for all text
- Percentage calculation: `Math.round((answeredCount / totalQuestions) * 100)`, handle totalQuestions=0 edge case (return 0)
- Wrap in `<nav aria-label="Progress" className="mb-8">`

**2. Create CategoryStep component:**

Create `src/app/[locale]/gap-analysis/steps/category-step.tsx`:
- `'use client'` directive
- Props: `categoryId: string`, `isFirstCategory: boolean`, `isLastCategory: boolean`
- Import: `useForm`, `Controller` from `react-hook-form`, `zodResolver` from `@hookform/resolvers/zod`, `z` from `zod`, `useTranslations` from `next-intl`, `useGapAnalysisStore`, `RadioGroup`/`RadioGroupItem` from `@/components/ui/radio-group`, `Label` from `@/components/ui/label`, `getQuestionsByCategory` from `@/lib/nis2/questions`, `useRouter` from `next-intl/navigation` (or `next/navigation`)
- Get questions for this category: `const questions = getQuestionsByCategory(categoryId)`
- Build Zod schema dynamically from questions: `z.object({ [q.id]: z.coerce.number().min(0).max(3) })` for each question. Use `z.coerce.number()` because RadioGroup values are strings. Define schema inside the component.
- Get existing answers from store: `useGapAnalysisStore((state) => state.getAnswersByCategory(categoryId))`
- Set defaultValues: For each question, check if an existing answer exists. If yes, use its `level`. If no, leave as `undefined` (do NOT default to 0 -- undefined means "not yet answered" which is important for progress tracking).

CRITICAL: Use `key={categoryId}` on the `<form>` element (or wrap in a fragment with key) to force React to remount the form when the category changes. Without this, React Hook Form will NOT re-initialize defaultValues when navigating between categories because the component instance is reused.

- **onSubmit handler:** Convert form data to `Answer[]` array (map entries to `{ questionId, categoryId, level: Number(value) as MaturityLevel }`), call `updateAnswers(categoryAnswers)`. If `isLastCategory`, navigate to `/{locale}/results` using `router.push`. Otherwise call `nextCategory()`.
- **onBack handler:** Before navigating back, save current form values (even if incomplete) using `getValues()` from useForm, convert to Answer[] (filtering out undefined values), call `updateAnswers(...)`, then call `prevCategory()`. This prevents data loss on backward navigation.
- **Render each question as a card:**
  - Question title from `t(question.titleKey)` using `useTranslations()` at root level (question titleKeys are like `questions.raQ1.title`, so use `useTranslations('questions')` and extract the question key part, OR use `useTranslations()` with no namespace and access `t(question.titleKey)` directly)
  - Tooltip icon (Info from lucide-react) with shadcn Tooltip showing `t(question.tooltipKey)`
  - 4 RadioGroup options (levels 0-3), each showing the maturity description from `t(question.maturityDescriptions.level0Key)` etc.
  - Each radio option renders as a card-like row: `<div className="flex items-start gap-3 rounded-lg border p-4 hover:bg-gray-50 transition-colors cursor-pointer">` containing RadioGroupItem + Label with the maturity description text
  - Use Controller pattern: `<Controller name={question.id} control={control} render={...} />`
  - RadioGroup value is string (Radix requirement), convert with `String(field.value)` and `field.onChange(Number(v))`

- **Navigation:** Reuse the WizardNavigation component from `@/app/[locale]/check/components/navigation.tsx` (import it). Pass:
  - `onBack`: the back handler (undefined if isFirstCategory)
  - `isFirstStep={isFirstCategory}`
  - `isLastStep={isLastCategory}`
  - `backLabel={t('gapAnalysis.navigation.back')}` (or use the right namespace)
  - `nextLabel` / `submitLabel`: from translations

NOTE on translations approach: The question titleKey values are stored as `questions.raQ1.title`. Use `useTranslations()` (no namespace) to access them with full dotted path, like `t(question.titleKey)`. Similarly for maturity descriptions. Alternatively, use `useTranslations('questions')` and strip the `questions.` prefix. Choose whichever is cleaner, but be consistent.

**3. Create Gap Analysis Page:**

Create `src/app/[locale]/gap-analysis/page.tsx`:
- `'use client'` directive
- Hydration guard pattern (exact same as check/page.tsx): `const [isClient, setIsClient] = useState(false)` + useEffect
- Import `useGapAnalysisStore` for `currentCategoryIndex` and `answers`
- Import `CATEGORIES` from `@/lib/nis2/categories` and `getQuestionsByCategory` from questions
- Import `getTotalQuestionCount` from `@/lib/nis2/questions`
- Import `CategoryProgress` and `CategoryStep`
- Build populated categories: `CATEGORIES.map(cat => ({ ...cat, questions: getQuestionsByCategory(cat.id) }))` -- the CATEGORIES array has empty `questions: []` arrays, they need to be populated from the QUESTIONS array
- Server skeleton: same pattern as check/page.tsx with animate-pulse divs
- Client render:
  - Page title: `<h1>{t('title')}</h1>` + subtitle
  - CategoryProgress with current category info, answered count from store
  - CategoryStep with `key={currentCategory.id}` (CRITICAL for form remount), passing categoryId, isFirstCategory, isLastCategory

**File structure:**
```
src/app/[locale]/gap-analysis/
  page.tsx
  components/
    category-progress.tsx
  steps/
    category-step.tsx
```
  </action>
  <verify>
1. Run `npm run build` -- must compile without errors
2. Run `npm run dev`, navigate to `http://localhost:3000/de/gap-analysis`:
   - Page renders with title "NIS2 Gap-Analyse"
   - Progress shows "Bereich 1 von 10" with category name and 0% bar
   - 3 questions visible with 4 radio options each showing maturity descriptions in German
   - Selecting answers and clicking "Weiter" advances to category 2
   - Progress updates to "Bereich 2 von 10" and percentage increases
   - Clicking "Zurueck" returns to category 1 with answers preserved
   - Refresh browser -- answers and current step restored from localStorage
3. Navigate to `http://localhost:3000/en/gap-analysis` -- English translations display
4. Check localStorage in DevTools: key `nis2-gap-analysis-storage` exists with answers array
5. Complete all 10 categories and verify navigation to /results on last step
  </verify>
  <done>
- Gap analysis wizard renders at /[locale]/gap-analysis
- 10 categories navigable via Back/Next buttons
- 3 questions per category with 4-level maturity RadioGroup selection
- Progress indicator shows "Bereich X von 10 - {categoryName}" and percentage bar
- Answers persist in zustand store with localStorage, survive refresh and backward navigation
- Last category submit navigates to results page
- Both DE and EN translations work
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Full flow test:** From landing page, go through affected check (Phase 3), click "Zur Gap-Analyse" on result page, complete all 10 categories, verify navigation to results
2. **Data persistence:** Answer 3 categories, close browser tab, reopen -- verify answers and category index restored
3. **Build:** `npm run build` passes with zero errors
4. **Existing tests:** `npm test` -- all 39 scoring engine tests still pass (no regressions)
5. **i18n:** Switch between DE and EN on the gap analysis page -- all text translates
6. **Accessibility:** Tab through radio options with keyboard, verify focus ring visible, verify aria attributes on progress bar
</verification>

<success_criteria>
1. User progresses through 10 category steps, answering 3 questions per category using the 4-level maturity scale (30 questions total)
2. Progress indicator shows current category name, number (e.g., "Bereich 3 von 10"), and overall completion percentage
3. User can navigate backward and forward between categories without any answers being lost
4. Answers persist in localStorage (nis2-gap-analysis-storage key) and survive page refresh
5. `npm run build` and `npm test` both pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-gap-analysis-wizard/04-01-SUMMARY.md`
</output>
